name: Android Tests (Simple)

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  workflow_dispatch:

jobs:
  android-tests:
    name: Run Android Tests
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm install

      # Setup Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          target: default
          arch: x86_64

      # Verify System Image Installation
      - name: Verify System Image Installation
        run: |
          echo "=== Checking installed system images ==="
          sdkmanager --list_installed | grep "system-images;android-33" || echo "System image not found, installing..."
          
          # Ensure system image is installed
          yes | sdkmanager "system-images;android-33;default;x86_64" || true
          
          echo "=== Installed system images ==="
          sdkmanager --list_installed | grep system-images

      # Create and Start Android Emulator
      - name: Create and Start Android Emulator
        timeout-minutes: 20
        continue-on-error: false
        run: |
          echo "=== Manual Emulator Setup ==="
          
          # Set Android SDK paths
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export ANDROID_AVD_HOME=$HOME/.android/avd
          export PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin
          
          # Verify emulator is available
          echo "Checking emulator path..."
          which emulator || find $ANDROID_HOME -name "emulator" -type f | head -1
          
          # Use full path if emulator not in PATH
          EMULATOR_CMD=$(which emulator || find $ANDROID_HOME -name "emulator" -type f | head -1)
          if [ -z "$EMULATOR_CMD" ]; then
            echo "❌ Emulator not found!"
            echo "ANDROID_HOME: $ANDROID_HOME"
            ls -la $ANDROID_HOME/emulator/ 2>/dev/null || echo "Emulator directory not found"
            exit 1
          fi
          echo "✅ Using emulator: $EMULATOR_CMD"
          
          # Step 1: Create AVD directory
          echo "Step 1: Creating AVD directory..."
          mkdir -p $HOME/.android/avd/test_emulator.avd
          
          # Step 2: Find system image
          echo "Step 2: Finding system image..."
          SYSTEM_IMAGE_PATH="$ANDROID_HOME/system-images/android-33/default/x86_64"
          
          # If not found, try to find any x86_64 image for API 33
          if [ ! -d "$SYSTEM_IMAGE_PATH" ]; then
            echo "System image not at expected path, searching..."
            SYSTEM_IMAGE_PATH=$(find $ANDROID_HOME/system-images -type d -path "*/android-33/*x86_64*" 2>/dev/null | head -1)
            if [ -z "$SYSTEM_IMAGE_PATH" ]; then
              echo "❌ No x86_64 system image found for API 33"
              echo "Available system images:"
              find $ANDROID_HOME/system-images -type d -maxdepth 3 2>/dev/null | head -10
              exit 1
            fi
            echo "✅ Found system image at: $SYSTEM_IMAGE_PATH"
          else
            echo "✅ System image found: $SYSTEM_IMAGE_PATH"
          fi
          
          # Extract the relative path for config.ini
          SYSTEM_IMAGE_REL_PATH=$(echo $SYSTEM_IMAGE_PATH | sed "s|$ANDROID_HOME/||")
          echo "Using system image path: $SYSTEM_IMAGE_REL_PATH"
          
          # Step 3: Create AVD
          echo "Step 3: Creating Android Virtual Device..."
          # Try to find the system image package name
          SYSTEM_IMAGE_PKG=$(find $SYSTEM_IMAGE_PATH -name "source.properties" -exec grep "Pkg.Path" {} \; 2>/dev/null | head -1 | cut -d'=' -f2 | tr -d ' ')
          if [ -z "$SYSTEM_IMAGE_PKG" ]; then
            SYSTEM_IMAGE_PKG="system-images;android-33;default;x86_64"
          fi
          echo "Using system image package: $SYSTEM_IMAGE_PKG"
          
          echo "no" | avdmanager create avd -n test_emulator -k "$SYSTEM_IMAGE_PKG" -d "pixel" -p $HOME/.android/avd/test_emulator.avd || {
            echo "AVD creation failed, trying without device profile..."
            echo "no" | avdmanager create avd -n test_emulator -k "$SYSTEM_IMAGE_PKG" -p $HOME/.android/avd/test_emulator.avd || true
          }
          
          # Step 4: Create .ini file manually if needed
          echo "Step 4: Creating AVD .ini file..."
          if [ ! -f $HOME/.android/avd/test_emulator.ini ]; then
            cat > $HOME/.android/avd/test_emulator.ini << EOF
          avd.ini.displayname = test_emulator
          avd.ini.encoding = UTF-8
          path = $HOME/.android/avd/test_emulator.avd
          EOF
            echo "✅ Created test_emulator.ini"
          fi
          
          # Step 5: Configure AVD for low resources with correct architecture
          echo "Step 5: Configuring AVD..."
          cat > $HOME/.android/avd/test_emulator.avd/config.ini << EOF
          avd.ini.displayname = test_emulator
          avd.ini.encoding = UTF-8
          disk.dataPartition.size = 1024M
          hw.ramSize = 1024
          hw.cpu.ncore = 2
          image.sysdir.1 = $SYSTEM_IMAGE_REL_PATH/
          hw.cpu.arch = x86_64
          abi.type = x86_64
          EOF
          
          # Step 6: Verify AVD
          echo "Step 6: Verifying AVD..."
          avdmanager list avd
          ls -la $HOME/.android/avd/
          ls -la $HOME/.android/avd/test_emulator.avd/ || echo "AVD directory not found"
          
          if [ ! -f $HOME/.android/avd/test_emulator.ini ]; then
            echo "❌ AVD .ini file not created!"
            exit 1
          fi
          echo "✅ AVD created successfully"
          
          # Step 7: Start ADB server
          echo "Step 7: Starting ADB server..."
          adb kill-server || true
          sleep 2
          adb start-server
          sleep 3
          
          # Step 8: Start emulator with explicit architecture
          echo "Step 8: Starting emulator..."
          # Try with KVM first, fallback to software acceleration
          if [ -c /dev/kvm ]; then
            echo "Starting with KVM hardware acceleration..."
            $EMULATOR_CMD -avd test_emulator -no-window -no-audio -no-snapshot-save -partition-size 1024 -accel on &
          else
            echo "Starting with software acceleration (KVM not available)..."
            $EMULATOR_CMD -avd test_emulator -no-window -no-audio -no-snapshot-save -partition-size 1024 -accel off &
          fi
          EMULATOR_PID=$!
          echo "Emulator started with PID: $EMULATOR_PID"
          
          # Wait a moment for emulator to initialize
          sleep 5
          
          # Step 9: Wait for device using adb wait-for-device
          echo "Step 9: Waiting for device (this may take 2-3 minutes)..."
          adb wait-for-device
          echo "✅ Device detected"
          
          # Step 10: Wait for device to be online
          echo "Step 10: Waiting for device to come online..."
          DEVICE_SERIAL=$(adb devices | grep "emulator" | awk '{print $1}' | head -1)
          echo "Device serial: $DEVICE_SERIAL"
          
          for i in {1..40}; do
            STATUS=$(adb devices | grep "$DEVICE_SERIAL" | awk '{print $2}')
            if [ "$STATUS" = "device" ]; then
              echo "✅ Device is online!"
              break
            fi
            if [ "$STATUS" = "offline" ]; then
              echo "Device offline, restarting ADB... ($i/40)"
              adb kill-server
              sleep 2
              adb start-server
              sleep 3
            else
              echo "Waiting... ($i/40) Status: $STATUS"
            fi
            sleep 3
          done
          
          # Step 11: Wait for boot completion
          echo "Step 11: Waiting for boot completion..."
          for i in {1..40}; do
            BOOT=$(adb -s $DEVICE_SERIAL shell getprop sys.boot_completed 2>/dev/null || echo "0")
            if [ "$BOOT" = "1" ]; then
              echo "✅ Boot completed!"
              break
            fi
            echo "Boot in progress... ($i/40)"
            sleep 3
          done
          
          # Step 12: Final verification
          echo "Step 12: Final verification..."
          adb devices
          
          # Verify emulator process is still running
          if ! ps -p $EMULATOR_PID > /dev/null 2>&1; then
            echo "❌ Emulator process died!"
            exit 1
          fi
          echo "✅ Emulator is ready and running (PID: $EMULATOR_PID)"
          
          # Keep emulator running by waiting (this step will keep emulator alive)
          echo "Keeping emulator running..."

      # Install Appium and Driver
      - name: Install Appium and Driver
        run: |
          echo "Installing Appium..."
          npm install -g appium@^2.19.0
          
          echo "Installing/updating UiAutomator2 driver..."
          appium driver update uiautomator2 || appium driver install uiautomator2 || {
            echo "⚠️ Driver update/install had issues, but continuing..."
          }
          
          echo "Verifying driver..."
          DRIVER_LIST=$(appium driver list --installed 2>&1 || echo "")
          echo "$DRIVER_LIST"
          
          if echo "$DRIVER_LIST" | grep -qi "uiautomator2"; then
            echo "✅ UiAutomator2 driver is installed"
          else
            echo "⚠️ UiAutomator2 driver not found in list, but continuing..."
            echo "Driver list output:"
            echo "$DRIVER_LIST"
          fi
          echo "✅ Appium and driver ready"

      # Start Appium Server
      - name: Start Appium Server
        run: |
          appium --log-level info &
          sleep 10
          echo "Appium server started"

      # Wait for Appium to be ready
      - name: Wait for Appium
        run: |
          until curl -f http://localhost:4723/wd/hub/status || [ $? -eq 22 ]; do
            echo "Waiting for Appium..."
            sleep 2
          done

      # Run tests
      - name: Run Android Tests
        run: npm run test:smoke:login
        continue-on-error: true

      # Generate Allure Report
      - name: Generate Allure Report
        if: always()
        run: |
          npm run report:allure:generate

      # Upload Allure Results
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: reports/allure-results
          retention-days: 30

      # Upload Allure Report
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: reports/allure-report
          retention-days: 30

      # Upload Screenshots
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: reports/screenshots
          retention-days: 7

      # Stop Android Emulator (cleanup)
      - name: Stop Android Emulator
        if: always()
        run: |
          echo "=== Stopping Emulator ==="
          adb -s emulator-5554 emu kill || true
          pkill -f "emulator.*test_emulator" || true
          echo "✅ Emulator stopped"
